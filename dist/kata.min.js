!function(e,r){"undefined"!=typeof module?module.exports=r():"function"==typeof define&&"object"==typeof define.amd?define(r()):this.kata=r()}(0,function(){var e,r={},t={src:!1,plugins:{}};function n(e,r,t){var n,i,s="",a=0,o="\\"+(r=r||"("),l="\\"+(t=t||")");if(new RegExp("^\\s*"+o).test(e)){for(i=new RegExp("\\s*((?:(?!\\{\\{|\\}\\}|"+o+"|"+l+")[\\s\\S])*?)("+o+"|"+l+")","g");n=i.exec(e);)if(r===n[2]?a+=1:a-=1,s+=(n[1]?n[1]:"")+n[2],!a)return{pos:i.lastIndex,value:s};throw new Error("Parenthetical missing "+t)}}return e=Object.create(Object.prototype,{parse:{value:function(e){if(this.parsed)throw new Error("Attempting to reparse "+this.symbol+" block");e&&/\S/.test(e)&&this.addChild("c").parse(e).render(),this.parsed=!0}},end:{value:null,writable:!0},addChild:{value:function(e,n){var i,s;if(!((s=r[e||"="])||(i=/^#(\w+)/.exec(e))&&(s=t.plugins[i[1]()])))throw new Error("Unknown block type: "+e);this.children||(this.children=[]);var a=this.children.push(Object.create(s,{start:{value:n||0}}));return this.children[a-1]}},render:{value:function(){return this.children?this.children.reduce(function(e,r){return e+r.rendered},""):""}}}),r.root=Object.create(e,{parsed:{value:!0},addChild:{value:function(r,t){if(this.children)throw new Error("Unexpected content after template definition");if("%"!=r)throw new Error("Expected Template block. Templates must begin with {{% ( not "+r+")");return e.addChild.call(this,r,t)}},render:{value:function(){if(!this.children)throw new Error("No template defined");return this.children[0].rendered}}}),r["%"]=Object.create(e,{symbol:{value:"%"},name:{value:null,writable:!0},args:{value:null,writable:!0},parse:{value:function(r){var t,i=/^\s*(\w+)/g;if((t=i.exec(r))&&(this.name=t[1],this.end+=i.lastIndex,r=r.substr(i.lastIndex)),!(t=n(r)))throw new Error("Template block missing arguments at position "+this.end);return this.args=t.value,this.end+=t.pos,e.parse.call(this,r.substr(t.pos)),this}},render:{value:function(){return this.rendered||(this.rendered="function "+(this.name?this.name:"")+this.args+"{var out='';"+e.render.call(this)+"return out;}"),this.rendered}},addChild:{value:function(r,t){if(":"===r)throw new Error("Template blocks cannot contain Elseif blocks directly");return e.addChild.call(this,r,t)}}}),r["="]=Object.create(e,{symbol:{value:"="},parse:{value:function(r){return this.expr=r.replace(/"/g,'\\"').replace(/\r|\n/g,"\\n"),e.parse.call(this),this}},render:{value:function(){return this.rendered||(this.rendered="out += ("+this.expr+') || "";'),this.rendered}},addChild:{value:function(){throw new Error("Interpolate blocks cannot contain other blocks")}}}),r["@"]=Object.create(e,{symbol:{value:"@"},parse:{value:function(r){var t;if(!(t=n(r,"[","]")))throw new Error("Iterate block missing iterable");if(this.iter=t.value.replace(/^\[/,"(").replace(/\]$/,")"),!(t=n(r=r.substr(t.pos))))throw new Error("Iterate block missing arguments");return this.args=t.value,e.parse.call(this,r.substr(t.pos)),this}},render:{value:function(){return this.rendered||(this.rendered=this.iter+".forEach(function"+this.args+"{"+e.render.call(this)+"});"),this.rendered}},addChild:{value:function(r,t){if(":"===r)throw new Error("Iterate blocks cannot contain Elseif blocks directly");return e.addChild.call(this,r,t)}}}),r["?"]=Object.create(e,{symbol:{value:"?"},parse:{value:function(r){var t;if(!(t=n(r)))throw new Error("Condition block missing condition");return this.cond=t.value,e.parse.call(this,r.substr(t.pos)),this}},render:{value:function(){return this.rendered||(this.rendered="if "+this.cond+"{"+e.render.call(this)+"}"),this.rendered}}}),r[":"]=Object.create(e,{symbol:{value:":"},parse:{value:function(r){var t;return(t=n(r))&&(this.cond=t.value,r=r.substr(t.pos)),e.parse.call(this,r),this}},render:{value:function(){return this.rendered||(this.rendered="} else "+(this.cond?"if "+this.cond:"")+"{"+e.render.call(this)),this.rendered}}}),r["+"]=Object.create(e,{symbol:{value:"+"},parse:{value:function(r){var t,i=/^\s*(\w+)/g;if(!(t=i.exec(r)))throw new Error("Import block missing alias");if(this.alias=t[1],!(t=n(r=r.substr(i.lastIndex))))throw new Error("Import block missing template location");return this.location=t.value,r=r.substr(t.pos),e.parse.call(this,r),this}},render:{value:function(){return this.rendered||(this.rendered="var "+this.alias+" = require"+this.location+";"),this.rendered}},addChild:{value:function(){throw new Error("Import blocks cannot contain other blocks.")}}}),r[">"]=Object.create(e,{symbol:{value:"<"},parse:{value:function(r){var t,i=/^\s*(\w+)/g;if(!(t=i.exec(r)))throw new Error("Invoke block missing template name");if(this.signature=t[1],this.end+=i.lastIndex,!(t=n(r=r.substr(i.lastIndex))))throw new Error("Invoke block missing ()");return this.signature+=t.value,this.end+=t.pos,e.parse.call(this,r.substr(t.pos)),this}},render:{value:function(){return this.rendered||(this.rendered="out+=(function(){"+e.render.call(this)+"return "+this.signature+";}());"),this.rendered}},addChild:{value:function(r,t){if("%"!=r)throw new Error("Invoke blocks can only contain Template blocks,");return e.addChild.call(this,r,t)}}}),r["<"]=Object.create(e,{symbol:{value:">"},parse:{value:function(r){var t,i=/^\s*(\w+)/g;if(!(t=i.exec(r)))throw new Error("Yield block missing template name");if(this.target=t[1],!(t=n(r=r.substr(i.lastIndex))))throw new Error("Yield block missing ()");return this.args=t.value,r=r.substr(t.pos),e.parse.call(this,r),this}},render:{value:function(){return this.rendered||(this.rendered="if (typeof "+target+' ==="function") out+='+this.target+this.args+"; else {"+e.render.call(this)+"}"),this.rendered}}}),r["!"]=Object.create(e,{symbol:{value:"!"},parse:{value:function(r){return this.expr=r,e.parse.call(this),this}},render:{value:function(){return this.rendered||(this.rendered=this.expr),this.rendered}},addChild:{value:function(){throw new Error("Evaluate blocks cannot contain other blocks")}}}),r.c=Object.create(e,{symbol:{value:"c"},parse:{value:function(r){return this.expr=r.replace(/"/g,'\\"').replace(/\r|\n/g,"\\n"),e.parse.call(this),this.end=this.start+r.length,this}},render:{value:function(){return this.rendered||(this.rendered='out+="'+this.expr+'";'),this.rendered}}}),function(e,n){var i,s=Object.create(r.root,{start:{value:0}}),a=s,o=[s],l=/((?:(?!\{\{(?:[%@\?:\+><!]|#\w+)?|[%@\?:\+><!#]?\}\})[\s\S])*)(\{\{(?:[%@\?:\+><!]|#\w+)?|[%@\?:\+><!#]?\}\})/g;for(n&&Object.keys(t).forEach(function(e){n.hasOwnProperty(e)&&(t[e]=n[e])});o.length&&(i=l.exec(e));){if(i[1]&&i[1].length&&(a.parsed?a.addChild("c",i.index).parse(i[1]).render():a.parse(i[1])),"{{"===i[2].substr(0,2))o.push(a.addChild(i[2].substr(2),l.lastIndex-i[2].length));else{if("root"===a.symbol)throw new Error("Expecting {{% but found "+i[2]+" at position "+(l.lastIndex-i[2].length));if(sym=3===i[2].length?i[2].substr(0,1):this.symbol,sym&&sym!=a.symbol)throw new Error("{{"+a.symbol+" at position "+a.start+" does not match "+sym+"}} at position "+(l.lastIndex-3));a.e=l.lastIndex,a.render(),o.pop()}a=o[o.length-1]}if(a!==s)throw new Error("Failed to find end of {{"+a.sym+" block begun at position "+a.s+"\nq has "+o.length+" items");return t.src?"(function(name, definition){  'use strict';  if (typeof module != 'undefined') {    module.exports = definition(require);  }  else if (typeof define == 'function' && typeof define.amd == 'object') {    define(definition);  }  else this[name] = definition();}('template', function(require){ return "+s.render()+"}));":new Function("return "+s.render())()}});
